name: Test

on:
  push:
    branches:
      - hy/actions

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # - name: Free Disk Space (Ubuntu)
      #   uses: jlumbroso/free-disk-space@main
      #   with:
      #     # this might remove tools that are actually needed,
      #     # if set to "true" but frees about 6 GB
      #     tool-cache: false
      #     # all of these default to true, but feel free to set to
      #     # "false" if necessary for your workflow
      #     android: true
      #     dotnet: true
      #     haskell: true
      #     large-packages: true
      #     docker-images: true
      #     swap-storage: true
      - name: Checkout
        uses: actions/checkout@v3

      - name: Checkout gpdb
        uses: actions/checkout@v3
        with:
          repository: greenplum-db/gpdb
          path: gpdb

      - name: Compile
        run: |
          sudo apt-get update
          cd gpdb
          sudo ./README.Ubuntu.bash
          ssh-keygen -q -t rsa -N '' -f ~/.ssh/id_rsa <<<y >/dev/null 2>&1
          cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
          chmod 600 ~/.ssh/authorized_keys
          mkdir -p ~/.ssh     
          echo "Host *" > ~/.ssh/config     
          echo " StrictHostKeyChecking no" >> ~/.ssh/config
          ./configure --with-python --disable-orca --disable-gpcloud --with-gssapi --with-libxml --prefix=/home/runner/.local/gpdb
          make -j8 && make install
          make -C src/test/isolation2 install

      - name: Install python package
        run: |
          cd gpdb
          pip3 install -r python-dependencies.txt
          pip3 install cmake

      - name: Run GPDB 
        run: |
          cd gpdb
          source /home/runner/.local/gpdb/greenplum_path.sh
          LANG=en_US.utf8 make create-demo-cluster

      - name: diskquota
        run: |
          source /home/runner/.local/gpdb/greenplum_path.sh 
          source gpdb/gpAux/gpdemo/gpdemo-env.sh
          mkdir build
          cd build
          cmake ..
          make
          make install
          gpconfig -c shared_preload_libraries -v 'diskquota-2.2'
          gpstop -ar
          make installcheck

      - name: Setup upterm session
        if: ${{  failure() }}
        uses: lhotari/action-upterm@v1
 